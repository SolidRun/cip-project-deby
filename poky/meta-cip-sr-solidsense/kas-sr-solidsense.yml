# Copyright (C) 2016-2017, Solidrun, Eric Bree <eric.bree@solid-run.com>
# SPDX-License-Identifier:	MIT
# CIP core kas solidsense configuration
header:
    version: 7
machine: solidsense
distro: deby
repos:
    meta-custom:
        layers:
            poky/meta-cip-common:
            poky/meta-cip-sr-solidsense:
    meta-debian:
        url: "https://github.com/meta-debian/meta-debian.git"
        refspec: warrior
    meta-openembedded:
        url: "https://github.com/openembedded/meta-openembedded.git"
        refspec: warrior
        layers:
           meta-filesystems:
           meta-networking:
           meta-oe:
           meta-python:
    meta-virtualization:
        url: "https://git.yoctoproject.org/git/meta-virtualization"
        refspec: warrior
    poky:
        url: "https://git.yoctoproject.org/git/poky.git"
        refspec: warrior
        layers:
            meta:
            meta-poky:
    meta-java:
        url: "https://github.com/solidrun-ejb/meta-java.git"
        refspec: meta-cip-sr-solidsense
    meta-mender-core:
        url: "https://github.com/solidrun-ejb/meta-mender.git"
        refspec: meta-cip-sr-solidsense
        layers:
            meta-mender-core:
bblayers_conf_header:
  meta-custom: |
    LCONF_VERSION = "6"
    BBPATH = "${TOPDIR}"
    BBFILES ?= ""
local_conf_header:
  meta-custom: |
    BB_NUMBER_THREADS ?= "${@oe.utils.cpu_count()}"
    PARALLEL_MAKE ?= "-j ${@oe.utils.cpu_count()}"
    PACKAGE_CLASSES ?= "package_rpm"
    EXTRA_IMAGE_FEATURES = "debug-tweaks"
    USER_CLASSES ?= "buildstats image-mklibs image-prelink"
    PATCHRESOLVE = "noop"
    BB_DISKMON_DIRS = "\
        STOPTASKS,${TMPDIR},1G,100K \
        STOPTASKS,${DL_DIR},1G,100K \
        STOPTASKS,${SSTATE_DIR},1G,100K \
        ABORT,${TMPDIR},100M,1K \
        ABORT,${DL_DIR},100M,1K \
        ABORT,${SSTATE_DIR},100M,1K"
    CONF_VERSION = "1"
    DL_DIR ?= "/home/eric/work.kingcheese/downloads"
    #
    #SRC_URI_ALLOWED = " \
    #    git://github.com/ystk/ \
    #    git://github.com/SolidRun/ \
    #    ${BOOTLOADER_GIT_URI}/${BOOTLOADER_GIT_PREFIX} \
    #"

    # Add distro features
    DISTRO_FEATURES += " virtualization"
    
    # Enable read only rootfs
    EXTRA_IMAGE_FEATURES += "read-only-rootfs"

    #
    # Install zimage, dtb and kernel modules
    #
    #IMAGE_INSTALL_append = " kernel-devicetree kernel-image-zimage kernel-modules u-boot linux-firmware"
    IMAGE_INSTALL_append += "kernel-devicetree kernel-image-zimage kernel-modules firmware-wireless-wilink8"
    IMAGE_INSTALL_append += "openssh mmc-utils"

    # Add additional packages
    #IMAGE_INSTALL_append = " docker u-boot-fw-utils wireless-regdb iw"
    IMAGE_INSTALL_append += "docker u-boot-fw-utils wireless-regdb iw util-linux hostapd bluez5"

    # Temporary additional packages
    IMAGE_INSTALL_append += "python3 grpc nfs-utils openjdk-8"
    PREFERRED_PROVIDER_virtual/java-native = "cacao-native"
    PREFERRED_PROVIDER_virtual/java-initial-native = "cacao-initial-native"
    #PREFERRED_PROVIDER_virtual/java-native = "jamvm-native"
    #PREFERRED_PROVIDER_virtual/java-initial-native = "jamvm-initial-native"

    # Mender
    INHERIT += "mender-full"
    MENDER_ARTIFACT_NAME = "Solidsense 2019090400"
    PREFERRED_PROVIDER_u-boot-fw-utils = "u-boot-fw-utils"
    #MENDER_FEATURES_ENABLE_append = " mender-uboot mender-image-sd"
    MENDER_FEATURES_ENABLE_append = " mender-uboot"
    MENDER_FEATURES_DISABLE_append = " mender-grub mender-image-uefi"
